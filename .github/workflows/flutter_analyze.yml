name: Flutter Analyze

on:
  pull_request:
    branches: [ "main", "develop", "feature/*" ]

env:
  flutter_version: 3.24.3

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # flutterインストール
      - name: "Install Flutter"
        run: sh ./.github/workflows/scripts/install-flutter.sh ${{ env.flutter_version }}


      - run: flutter pub get

      - name: Run Build Runner
        run: bin/run_build_runner

      - name: Run Flutter Analyze
        id: analyze
        run: |
          # 解析結果をファイルに保存
          flutter analyze lib --write=filename> analyze_result.txt || true

          # Filter only lines containing 'info' or 'warning'
          grep -E "(info|warning) •" analyze_result.txt > filtered_result.txt || true

          # Output the filtered results
          echo "Filtered Analysis Results:"
          cat filtered_result.txt

      - name: Upload artifact (Flutter Analyze Results)
        uses: actions/upload-artifact@v3
        with:
          name: flutter-analyze-results
          path: filtered_result.txt

      - name: Post PR comment
        env:
          PR_NUMBER: ${{ github.event.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          # コメント内容を準備
           if [ -s filtered_result.txt ]; then
            echo "### Flutter Analyze Results" > /tmp/comment
            echo "The full analysis results are available as an artifact in the Actions tab." >> /tmp/comment
            echo "You can download it from the [Artifacts section](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})." >> /tmp/comment
            echo "*Generated by GitHub Actions.*" >> /tmp/comment
           else
             echo "### Flutter Analyze Results" > /tmp/comment
             echo "No issues found! 🎉" >> /tmp/comment
             echo "*Generated by GitHub Actions.*" >> /tmp/comment
           fi

          # コメントを投稿
          gh pr comment "$PR_NUMBER" -F /tmp/comment

      - name: Comment to PR
        env:
          PR_NUMBER: ${{ github.event.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # PR番号を取得
           PR_NUMBER=${{ github.event.pull_request.number }}



           # コメントを投稿
           gh pr comment "$PR_NUMBER" -F /tmp/comment
